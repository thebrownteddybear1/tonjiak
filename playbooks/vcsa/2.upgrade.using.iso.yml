---
- name: VCSA 8 Fresh Stage and Upgrade (ISO)
  hosts: vcsa52
  gather_facts: no
  vars:
    ansible_user: root

  tasks:
    - name: Remove all staged patches before proceeding
      ansible.builtin.raw: "software-packages unstage"
      register: unstage_output
      changed_when: "'Staged packages purged successfully' in unstage_output.stdout"

    - name: Stage patches from the mounted ISO
      ansible.builtin.raw: "software-packages stage --iso --acceptEulas"
      register: stage_result
      # This task may take a few minutes depending on the ISO size

    - name: Install staged patches
      ansible.builtin.raw: "software-packages install --staged"
      register: install_result
      # WARNING: This process can take 30-60 minutes. 
      # Ensure your SSH timeout settings are sufficient.

    - name: Reboot VCSA to finalize upgrade
      ansible.builtin.raw: 'shutdown reboot -r "Ansible Patching Reboot"'
      when: "'Reboot is required' in install_result.stdout"
