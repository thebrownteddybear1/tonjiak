---
- name: Stage 2 - Execute VCSA Upgrade
  hosts: vcsa_nodes
  gather_facts: false

  tasks:
    - name: Clean up any previous failed sessions
      raw: "software-packages unstage"
      ignore_errors: true

    - name: Install software directly from ISO
      # Using raw to bypass the vCLI restricted shell
      raw: "software-packages install --iso --acceptEulas"
      register: install_out
      # Crucial: Keep the SSH session alive for the 30-60 minute duration
      vars:
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=120'

    - name: Show Installation Result
      debug:
        var: install_out.stdout_lines

    - name: Reboot the VCSA
      raw: "shutdown reboot -r 'Ansible Post-upgrade reboot'"
      ignore_unreachable: true

    - name: Wait for VCSA to return online
      wait_for:
        host: "{{ ansible_host }}"
        port: 443
        delay: 300
        timeout: 1200
      delegate_to: localhost

    - name: Final Version Check
      raw: "vpxd -v"
      register: vpxd_version

    - name: Display New Version
      debug:
        msg: "Upgrade Complete. {{ vpxd_version.stdout }}"