---
- name: Complete VCSA Upgrade Process
  hosts: all
  gather_facts: false

  tasks:
    # -------------------------------------------------------------------------
    # STAGE 0: FIX SHELL (New Fix for VCSA)
    # -------------------------------------------------------------------------
    - name: Set VCSA shell to Bash
      raw: shell.set --enabled True && pipecfg --reset && usermod -s /bin/bash root
      when: inventory_hostname == 'vcsa52'
      ignore_errors: true

    # -------------------------------------------------------------------------
    # STAGE 1: MOUNT ISO (Executed via ESXi Host)
    # -------------------------------------------------------------------------
    - name: Attach ISO to VCSA VM
      community.vmware.vmware_guest:
        hostname: "192.168.50.108"
        username: "root"
        password: "VMware1!VMware1!VMware1!VMware1!"
        validate_certs: false
        datacenter: "ha-datacenter"
        name: "vcsa52.corp.internal"
        cdrom:
          - controller_type: ide
            controller_number: 0
            unit_number: 0
            iso_path: "[lex2] iso/VMware-vCenter-Server-Appliance-8.0.3.00100-24091160-patch-FP.iso"
            type: iso
            state: present
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'

    # -------------------------------------------------------------------------
    # STAGE 2: UPGRADE VCSA
    # -------------------------------------------------------------------------
    - name: Perform Upgrade inside VCSA
      block:
        - name: Stage the software packages from ISO
          # Using 'shell' here now that we are in Bash
          shell: "software-packages stage --iso"
          register: stage_out
          failed_when: 
            - "'Staging complete' not in stage_out.stdout"
            - "'already staged' not in stage_out.stdout"

        - name: Install the staged updates
          shell: "software-packages install --staged --acceptEulas"
          async: 3600
          poll: 60
          register: install_out

        - name: Reboot the VCSA Appliance
          shell: "shutdown reboot -r 'Ansible triggered upgrade'"
          async: 1
          poll: 0
          ignore_unreachable: true

      when: inventory_hostname == 'vcsa52'
      vars:
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no'

    # -------------------------------------------------------------------------
    # STAGE 3: VERIFICATION
    # -------------------------------------------------------------------------
    - name: Wait for VCSA to return
      wait_for:
        host: "192.168.50.52"
        port: 443
        delay: 300
        timeout: 900
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'