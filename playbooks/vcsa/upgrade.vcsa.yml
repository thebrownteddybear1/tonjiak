---
- name: Complete VCSA Upgrade Process
  hosts: all
  gather_facts: false

  tasks:
    # -------------------------------------------------------------------------
    # STAGE 1: MOUNT ISO (Executed via ESXi API)
    # -------------------------------------------------------------------------
    - name: Attach ISO to VCSA VM
      community.vmware.vmware_guest:
        hostname: "192.168.50.108"
        username: "root"
        password: "VMware1!VMware1!VMware1!VMware1!"
        validate_certs: false
        datacenter: "ha-datacenter"
        name: "vcsa52.corp.internal"
        cdrom:
          - controller_type: ide
            controller_number: 0
            unit_number: 0
            iso_path: "[lex2] iso/VMware-vCenter-Server-Appliance-8.0.3.00100-24091160-patch-FP.iso"
            type: iso
            state: present
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'

    # -------------------------------------------------------------------------
    # STAGE 2: UPGRADE VCSA (Using RAW for vCLI)
    # -------------------------------------------------------------------------
    - name: Perform Upgrade inside VCSA
      block:
        - name: Stage the software packages from ISO
          raw: "software-packages stage --iso"
          register: stage_out
          # We use raw, so we must check the text output manually
          failed_when: "'Staging complete' not in stage_out.stdout and 'already staged' not in stage_out.stdout"

        - name: Install the staged updates
          # This command starts the actual install process inside vCLI
          raw: "software-packages install --staged --acceptEulas"
          register: install_out

        - name: Show Install Output
          debug:
            var: install_out.stdout_lines

        - name: Reboot the VCSA Appliance
          raw: "shutdown reboot -r 'Ansible triggered upgrade'"
          ignore_unreachable: true

      when: inventory_hostname == 'vcsa52'
      vars:
        # Prevents SSH from hanging on key confirmation
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no'

    # -------------------------------------------------------------------------
    # STAGE 3: VERIFICATION
    # -------------------------------------------------------------------------
    - name: Wait for VCSA to return
      wait_for:
        host: "192.168.50.52"
        port: 443
        delay: 300
        timeout: 1200 # Upgraded VCSA 8.0 takes a while to boot services
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'