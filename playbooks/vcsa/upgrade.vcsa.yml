---
- name: Complete VCSA Upgrade Process
  hosts: all
  gather_facts: false

  tasks:
    # -------------------------------------------------------------------------
    # STAGE 1: MOUNT ISO (Via ESXi API)
    # -------------------------------------------------------------------------
    - name: Attach ISO to VCSA VM via ESXi Host
      community.vmware.vmware_guest:
        hostname: "192.168.50.108"
        username: "root"
        password: "VMware1!VMware1!VMware1!VMware1!"
        validate_certs: false
        datacenter: "ha-datacenter"
        name: "vcsa52.corp.internal"
        cdrom:
          - controller_type: ide
            controller_number: 0
            unit_number: 0
            iso_path: "[lex2] iso/VMware-vCenter-Server-Appliance-8.0.3.00100-24091160-patch-FP.iso"
            type: iso
            state: present
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'

    # -------------------------------------------------------------------------
    # STAGE 2: UPGRADE (SSH to 192.168.50.52)
    # -------------------------------------------------------------------------
    - name: Perform Upgrade inside VCSA vCLI
      block:
        - name: Run Direct Install from ISO
          # 'raw' bypasses the VCSA's limited shell restrictions
          raw: "software-packages install --iso --acceptEulas"
          register: install_out

        - name: Show Installation Output
          debug:
            var: install_out.stdout_lines

        - name: Reboot the Appliance
          raw: "shutdown reboot -r 'Post-upgrade reboot'"
          ignore_unreachable: true

      when: inventory_hostname == 'vcsa52'
      vars:
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no'

    # -------------------------------------------------------------------------
    # STAGE 3: VERIFICATION
    # -------------------------------------------------------------------------
    - name: Wait for VCSA Web Services (Port 443)
      wait_for:
        host: "192.168.50.52"
        port: 443
        delay: 300
        timeout: 1200
      delegate_to: localhost
      when: inventory_hostname == 'vcsa52'

    - name: Check Final Version
      raw: "vpxd -v"
      register: version_check
      when: inventory_hostname == 'vcsa52'

    - name: Display New Build Info
      debug:
        msg: "Upgrade Successful! New Version: {{ version_check.stdout }}"
      when: inventory_hostname == 'vcsa52'