---
- name: Create Tier-0 Gateway with BGP on VLAN11 uplink
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    nsxt_host: "192.168.50.54"
    nsxt_user: "admin"
    nsxt_pass: "VMware1!VMware1!"
    
    # Uplink segment details
    uplink_segment_name: "segment-uplink-vlan11"
    uplink_interface_ip: "192.168.11.1"
    uplink_prefix_len: 24
    
    # Edge cluster details
    edge_cluster_name: "edge-cluster-1"
    edge_node_name: "edge1"
    
    # BGP configuration
    local_as: 65002
    neighbor_ip: "192.168.11.53"
    neighbor_as: 65001
  
  tasks:
    - name: Create Tier-0 Gateway with uplink interface and BGP
      vmware.ansible_for_nsxt.nsxt_policy_tier0:
        hostname: "{{ nsxt_host }}"
        username: "{{ nsxt_user }}"
        password: "{{ nsxt_pass }}"
        validate_certs: false
        
        # Basic Tier-0 configuration
        display_name: "tier0-gateway"
        description: "Tier-0 Gateway with VLAN11 uplink and BGP"
        state: present
        ha_mode: "ACTIVE_STANDBY"
        failover_mode: "PREEMPTIVE"
        disable_firewall: true
        force_whitelisting: true
        
        # Locale Services
        locale_services:
          - state: present
            id: "default-locale-service"
            display_name: "default-locale-service"
            
            # Edge cluster info (required for interfaces)
            edge_cluster_info:
              edge_cluster_display_name: "{{ edge_cluster_name }}"
            
            # Uplink interface on VLAN 11 segment
            interfaces:
              - state: present
                id: "vlan11-uplink-interface"
                display_name: "vlan11-uplink"
                segment_display_name: "{{ uplink_segment_name }}"
                subnets:
                  - ip_addresses: ["{{ uplink_interface_ip }}"]
                    prefix_len: "{{ uplink_prefix_len }}"
                urpf_mode: "STRICT"
                mtu: 1500
                type: "EXTERNAL"
                edge_node_info:
                  site_id: "default"
                  enforcementpoint_id: "default"
                  edge_cluster_display_name: "{{ edge_cluster_name }}"
                  edge_node_display_name: "{{ edge_node_name }}"
            
            # BGP Configuration
            BGP:
              state: present
              enabled: true
              local_as_num: "{{ local_as }}"
              inter_sr_ibgp: true
              graceful_restart_config:
                mode: "GR_AND_HELPER"
                timer:
                  restart_timer: 180
                  stale_route_timer: 600
              
              # BGP Neighbor
              neighbors:
                - state: present
                  display_name: "bgp-neighbor-{{ neighbor_ip }}"
                  neighbor_address: "{{ neighbor_ip }}"
                  remote_as_num: "{{ neighbor_as }}"
                  keep_alive_time: 60
                  hold_down_time: 180
                  allow_as_in: false
                  # password: "your-bgp-password"  # Uncomment and add if needed
                  bfd:
                    enabled: false
                    interval: 1000
                    multiple: 3
            
            # Route Redistribution - REDISTRIBUTE ALL INTO BGP
            route_redistribution_config:
              bgp_enabled: true
              redistribution_rules:
                # Redistribute ALL Tier-0 routes
                - name: "tier0-all-routes"
                  route_redistribution_types: 
                    - "TIER0_CONNECTED"
                    - "TIER0_STATIC"
                    - "TIER0_NAT"
                    - "TIER0_LB_VIP"
                    - "TIER0_LB_SNAT"
                    - "TIER0_DNS_FORWARDER_IP"
                    - "TIER0_IPSEC_LOCAL_IP"
                
                # Redistribute ALL Tier-1 routes
                - name: "tier1-all-routes"
                  route_redistribution_types:
                    - "TIER1_STATIC"
                    - "TIER1_CONNECTED"
                    - "TIER1_LB_VIP"
                    - "TIER1_LB_SNAT"
                    - "TIER1_NAT"
                    - "TIER1_DNS_FORWARDER_IP"
                    - "TIER1_IPSEC_LOCAL_IP"
        
        # Optional: Default static route
        static_routes:
          - state: present
            display_name: "default-route"
            network: "0.0.0.0/0"
            next_hops:
              - ip_address: "{{ neighbor_ip }}"
                admin_distance: 1

    - name: Display configuration summary
      debug:
        msg: |
          ‚úÖ Tier-0 Gateway configured:
          
          üìç Interface:
            - Name: vlan11-uplink
            - Segment: {{ uplink_segment_name }}
            - IP: {{ uplink_interface_ip }}/{{ uplink_prefix_len }}
            - Edge Node: {{ edge_node_name }} (Cluster: {{ edge_cluster_name }})
          
          üö¶ BGP Configuration:
            - Local AS: {{ local_as }}
            - Neighbor: {{ neighbor_ip }} (AS {{ neighbor_as }})
          
          üîÑ Route Redistribution:
            - All Tier-0 routes redistributed to BGP
            - All Tier-1 routes redistributed to BGP