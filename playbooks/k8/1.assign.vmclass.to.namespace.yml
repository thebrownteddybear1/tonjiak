---
- name: Assign VM Classes to Supervisor Namespace
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
    vm_classes:
      - "best-effort-small"
      - "best-effort-medium"

  tasks:
    # ===== PHASE 1: LOGIN (Native URI) =====
    - name: Authenticate with vCenter
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        force_basic_auth: true
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        status_code: 201
      register: login_response

    # ===== PHASE 2: ASSIGN VM CLASSES (PATCH) =====
    - name: Patch Namespace with VM Classes
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespace-management/software/namespaces/{{ namespace_name }}"
        method: PATCH
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ login_response.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          vm_classes: "{{ vm_classes }}"
        status_code: [200, 204]
      register: patch_result

    # ===== PHASE 3: VERIFY =====
    - name: Get Namespace details to verify classes
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespace-management/software/namespaces/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ login_response.json }}"
      register: ns_details

    - name: Final Confirmation
      debug:
        msg: 
          - "Namespace: {{ namespace_name }}"
          - "Assigned Classes: {{ ns_details.json.vm_classes }}"

    # ===== PHASE 4: LOGOUT =====
    - name: Close Session
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: DELETE
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ login_response.json }}"
        status_code: 204
      when: login_response.json is defined