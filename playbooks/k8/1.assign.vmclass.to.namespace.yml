---
- name: Assign VM Classes to Supervisor Namespace
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
    # Add as many classes as you need to this list
    vm_classes:
      - "best-effort-small"
      - "best-effort-medium"

  tasks:
    # ===== PHASE 1: LOGIN =====
    - name: Authenticate with vCenter
      vmware.vmware_rest.cis_session:
        vcenter_hostname: "{{ vcenter_host }}"
        vcenter_username: "{{ vcenter_username }}"
        vcenter_password: "{{ vcenter_password }}"
        vcenter_validate_certs: false
      register: session

    # ===== PHASE 2: ASSIGN VM CLASSES =====
    # We use the PATCH method as requested to update the namespace software configuration
    - name: Patch Namespace with VM Classes
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespace-management/software/namespaces/{{ namespace_name }}"
        method: PATCH
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session.session_key }}"
          Content-Type: "application/json"
        body_format: json
        body:
          vm_classes: "{{ vm_classes }}"
        status_code: [200, 204]
      register: patch_result

    # ===== PHASE 3: VERIFY =====
    - name: Get Namespace details to verify classes
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespace-management/software/namespaces/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session.session_key }}"
      register: ns_details

    - name: Final Confirmation
      debug:
        msg: 
          - "Namespace: {{ namespace_name }}"
          - "Assigned Classes: {{ ns_details.json.vm_classes }}"

    # ===== PHASE 4: LOGOUT =====
    - name: Close Session
      vmware.vmware_rest.cis_session:
        state: absent
      when: session.session_key is defined