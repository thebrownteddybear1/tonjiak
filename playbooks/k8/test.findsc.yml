---
- name: Create Supervisor Namespace 'vns'
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
  
  tasks:
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: true
        status_code: 201
      register: session_result
      no_log: true
    
    - name: Find cluster 'cluster' MOID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/cluster"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: clusters
    
    - name: Set cluster MOID for 'cluster'
      set_fact:
        cluster_moid: "{{ item.cluster }}"
      loop: "{{ clusters.json }}"
      when: item.name == "cluster"
    
    - name: Fail if cluster 'cluster' not found
      fail:
        msg: "Cluster 'cluster' not found. Available clusters: {{ clusters.json | map(attribute='name') | list }}"
      when: cluster_moid is not defined
    
    - name: Get all storage policies
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/storage/policies"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: storage_policies
    
    - name: Debug - Show all storage policies
      debug:
        msg: "Found storage policy: {{ item.name }} (ID: {{ item.policy }})"
      loop: "{{ storage_policies.json }}"
    
    - name: Find storage policy 'storageclass' (case-insensitive)
      set_fact:
        storage_policy_id: "{{ item.policy }}"
      loop: "{{ storage_policies.json }}"
      when: '"storageclass" in item.name | lower'
    
    - name: Check if we found storageclass policy
      debug:
        msg: "Found storage policy 'storageclass' with ID: {{ storage_policy_id }}"
      when: storage_policy_id is defined
    
    - name: Fail if storage policy 'storageclass' not found
      fail:
        msg: "Storage policy 'storageclass' not found. Available policies: {{ storage_policies.json | map(attribute='name') | list }}"
      when: storage_policy_id is not defined
    
    - name: Check if namespace 'vns' already exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: namespace_check
      ignore_errors: true
    
    - name: Debug namespace check result
      debug:
        msg: "Namespace check status: {{ namespace_check.status }}"
    
    - name: Create Supervisor Namespace 'vns' if it doesn't exist
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          cluster: "{{ cluster_moid }}"
          namespace: "{{ namespace_name }}"
          storage_specs:
            - policy: "{{ storage_policy_id }}"
              limit: -1
        status_code: [201, 204]  # Accept both 201 Created and 204 No Content
      register: namespace_result
      no_log: true
      when: namespace_check.status != 200
      ignore_errors: true
    
    - name: Get namespace status
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: namespace_status
    
    - name: Display namespace info
      debug:
        msg: |
          Namespace '{{ namespace_name }}':
          Status: {{ namespace_status.json.status }}
          Config Status: {{ namespace_status.json.config_status }}
          Cluster: {{ namespace_status.json.cluster }}
          Storage Specs: {{ namespace_status.json.storage_specs | default('Not specified') }}
    
    - name: Wait for namespace to be ready if not already
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: namespace_ready
      until: namespace_ready.json.status == "READY"
      retries: 30
      delay: 5
      when: namespace_status.json.status != "READY"
    
    - name: Final status
      debug:
        msg: "Namespace '{{ namespace_name }}' is {{ namespace_ready.json.status | default(namespace_status.json.status) }}"