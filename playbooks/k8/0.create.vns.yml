---
- name: Create Supervisor Namespace 'vns' with Sleep
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
  
  tasks:
    # ===== PHASE 1: AUTHENTICATION =====
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: true
        status_code: 201
      register: session_result
    
    # ===== PHASE 2: GET REQUIRED IDs =====
    - name: Find cluster 'cluster' MOID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/cluster"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: clusters
    
    - name: Set cluster MOID for 'cluster'
      set_fact:
        cluster_moid: "{{ item.cluster }}"
      loop: "{{ clusters.json }}"
      when: item.name == "cluster"
    
    - name: Fail if cluster 'cluster' not found
      fail:
        msg: "Cluster 'cluster' not found. Available clusters: {{ clusters.json | map(attribute='name') | list }}"
      when: cluster_moid is not defined
    
    - name: Find storage policy 'storageclass' ID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/storage/policies"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: storage_policies
    
    - name: Set storage policy ID for 'storageclass'
      set_fact:
        storage_policy_id: "{{ item.policy }}"
      loop: "{{ storage_policies.json }}"
      when: item.name == "storageclass"
    
    - name: Fail if storage policy 'storageclass' not found
      fail:
        msg: "Storage policy 'storageclass' not found. Available policies: {{ storage_policies.json | map(attribute='name') | list }}"
      when: storage_policy_id is not defined
    
    # ===== PHASE 3: DELETE EXISTING NAMESPACE =====
    - name: Check if namespace '{{ namespace_name }}' exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: namespace_check
      ignore_errors: true
    
    - name: Delete namespace if it exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: DELETE
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: [200, 204]
      when: namespace_check.status == 200
      register: delete_result
    
    - name: Sleep 20 seconds after deletion
      pause:
        seconds: 20
      when: namespace_check.status == 200
    
    # ===== PHASE 4: CREATE NEW NAMESPACE =====
    - name: Create Supervisor Namespace '{{ namespace_name }}'
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          cluster: "{{ cluster_moid }}"
          namespace: "{{ namespace_name }}"
          storage_specs:
            - policy: "{{ storage_policy_id }}"
              limit: -1
        status_code: [200, 201, 204]
      register: create_result
    
    - name: Sleep 20 seconds after creation
      pause:
        seconds: 20
    
    - name: Check namespace status after sleep
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: namespace_status
      ignore_errors: true
    
    - name: Display namespace status
      debug:
        msg: |
          Namespace '{{ namespace_name }}' creation attempt completed.
          Status code: {{ namespace_status.status }}
          {% if namespace_status.status == 200 %}
          Namespace status: {{ namespace_status.json.status | default(namespace_status.json.config_status) }}
          {% endif %}
    
    # ===== PHASE 5: DISCOVER AVAILABLE ROLES =====
    - name: Try to discover roles
      uri:
        url: "https://{{ vcenter_host }}/rest/com/vmware/cis/session/{{ session_result.json }}/authorization/roles"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: roles_api
      ignore_errors: true
    
    - name: Try alternative roles endpoint
      uri:
        url: "https://{{ vcenter_host }}/api/authorization/roles"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: roles_api2
      ignore_errors: true
    
    - name: Try another roles endpoint
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/authorization/roles"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: roles_api3
      ignore_errors: true
    
    - name: Display discovered roles endpoints
      debug:
        msg: |
          Roles API endpoints:
          - /rest/com/vmware/cis/session/.../authorization/roles: {{ roles_api.status }}
          - /api/authorization/roles: {{ roles_api2.status }}
          - /api/vcenter/authorization/roles: {{ roles_api3.status }}
    
    # ===== PHASE 6: TRY TO SET PERMISSIONS =====
    - name: Try common roles for permissions
      block:
        - name: Try 'Cns-Datastore' role
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              principal: "{{ vcenter_username }}"
              role: "Cns-Datastore"
            status_code: [200, 201, 204]
          register: perm_cns
          ignore_errors: true
        
        - name: Try 'Administrator' role
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              principal: "{{ vcenter_username }}"
              role: "Administrator"
            status_code: [200, 201, 204]
          register: perm_admin
          ignore_errors: true
        
        - name: Try 'Editor' role
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              principal: "{{ vcenter_username }}"
              role: "Editor"
            status_code: [200, 201, 204]
          register: perm_editor
          ignore_errors: true
    
    - name: Display permission results
      debug:
        msg: |
          Permission setting results:
          - Cns-Datastore: {{ 'Success' if perm_cns.status in [200, 201, 204] else 'Failed' }}
          - Administrator: {{ 'Success' if perm_admin.status in [200, 201, 204] else 'Failed' }}
          - Editor: {{ 'Success' if perm_editor.status in [200, 201, 204] else 'Failed' }}
    
    # ===== PHASE 7: FINAL CHECK =====
    - name: Final namespace check
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: final_check
      ignore_errors: true
    
    - name: Final summary
      debug:
        msg: |
          ===== NAMESPACE SETUP COMPLETE =====
          
          Summary:
          - Namespace: {{ namespace_name }}
          - Cluster: {{ cluster_moid }}
          - Storage Policy: {{ storage_policy_id }} (storageclass)
          
          {% if final_check.status == 200 %}
          - Status: {{ final_check.json.status | default(final_check.json.config_status) }}
          - Exists: Yes
          {% else %}
          - Status: Unknown (HTTP {{ final_check.status }})
          - Exists: No (check vCenter UI)
          {% endif %}
          
          Note: If permissions failed, set manually in vSphere UI:
          1. Go to Workload Management > Namespaces
          2. Select "{{ namespace_name }}" namespace  
          3. Go to Permissions tab
          4. Add "{{ vcenter_username }}" with "Edit" role
          
          =====================================