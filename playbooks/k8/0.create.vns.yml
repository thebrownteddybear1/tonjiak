---
- name: Create Supervisor Namespace 'vns' with Retry
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
    max_retries: 2
    retry_delay: 10
  
  tasks:
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: true
        status_code: 201
      register: session_result
    
    - name: Find cluster 'cluster' MOID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/cluster"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: clusters
    
    - name: Set cluster MOID for 'cluster'
      set_fact:
        cluster_moid: "{{ item.cluster }}"
      loop: "{{ clusters.json }}"
      when: item.name == "cluster"
    
    - name: Find storage policy 'storageclass' ID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/storage/policies"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: storage_policies
    
    - name: Set storage policy ID for 'storageclass'
      set_fact:
        storage_policy_id: "{{ item.policy }}"
      loop: "{{ storage_policies.json }}"
      when: item.name == "storageclass"
    
    # ===== DELETE NAMESPACE IF EXISTS =====
    - name: Check if namespace exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: namespace_check
      ignore_errors: true
    
    - name: Delete namespace if exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: DELETE
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: [200, 204]
      when: namespace_check.status == 200
      register: delete_result
    
    - name: Wait for namespace deletion
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 404
      register: deletion_check
      until: deletion_check.status == 404
      retries: 30
      delay: 2
      when: namespace_check.status == 200
    
    # ===== CREATE NAMESPACE WITH RETRY =====
    - name: Create namespace with retry
      block:
        - name: Attempt {{ ansible_loop.index }} - Create namespace
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              cluster: "{{ cluster_moid }}"
              namespace: "{{ namespace_name }}"
              storage_specs:
                - policy: "{{ storage_policy_id }}"
                  limit: -1
            status_code: [200, 201, 204]
          register: create_result
        
        - name: Wait for namespace to exist
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
            method: GET
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
            status_code: 200
          register: creation_check
          until: creation_check.status == 200
          retries: 10
          delay: 3
        
        - name: Wait for namespace to be ready
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
            method: GET
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
            status_code: 200
          register: namespace_status
          until: (namespace_status.json.status | default('')) in ["READY", "RUNNING"]
          retries: 30
          delay: 5
      
      rescue:
        - name: Retry failed, attempt {{ ansible_loop.index }} of {{ max_retries }}
          debug:
            msg: "Namespace creation attempt {{ ansible_loop.index }} failed, retrying in {{ retry_delay }} seconds..."
        
        - name: Wait before retry
          pause:
            seconds: "{{ retry_delay }}"
        
        - name: Re-check session (renew if needed)
          uri:
            url: "https://{{ vcenter_host }}/api/session"
            method: POST
            validate_certs: false
            user: "{{ vcenter_username }}"
            password: "{{ vcenter_password }}"
            force_basic_auth: true
            status_code: 201
          register: new_session
          when: ansible_loop.index == 2
        
        - name: Update session token for final retry
          set_fact:
            session_result: "{{ new_session }}"
          when: 
            - ansible_loop.index == 2
            - new_session is defined
        
        - name: Re-raise error to continue retry loop
          fail:
            msg: "Retrying namespace creation..."
      
      loop: "{{ range(1, max_retries + 1) | list }}"
      loop_control:
        loop_var: attempt_number
        index_var: ansible_loop.index
      retries: "{{ max_retries }}"
      delay: "{{ retry_delay }}"
      register: namespace_creation
    
    - name: Display success message
      debug:
        msg: "Namespace '{{ namespace_name }}' created successfully after {{ namespace_creation.attempts }} attempt(s)"
    
    # ===== SET PERMISSIONS WITH RETRY =====
    - name: Set permissions with retry
      block:
        - name: Attempt {{ ansible_loop.index }} - Set permissions
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              principal: "{{ vcenter_username }}"
              role: "Cns-Datastore"
            status_code: [200, 201, 204]
          register: permission_result
        
        - name: Verify permissions were set
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: GET
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
            status_code: 200
          register: verify_permissions
          when: permission_result.status in [200, 201, 204]
      
      rescue:
        - name: Permission setting attempt {{ ansible_loop.index }} failed
          debug:
            msg: "Permission setting failed, trying alternative role..."
        
        - name: Try with alternative role
          uri:
            url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/permissions"
            method: POST
            validate_certs: false
            headers:
              vmware-api-session-id: "{{ session_result.json }}"
              Content-Type: "application/json"
            body_format: json
            body:
              principal: "{{ vcenter_username }}"
              role: "Administrator"
            status_code: [200, 201, 204]
          register: alt_permission_result
          ignore_errors: true
        
        - name: Re-raise error if both attempts failed
          fail:
            msg: "Failed to set permissions after trying both roles"
          when: alt_permission_result.status not in [200, 201, 204]
      
      loop: "{{ range(1, 3) | list }}"
      loop_control:
        loop_var: perm_attempt
        index_var: perm_loop_index
      retries: 1
      delay: 2
      register: permission_setting
      when: namespace_creation is succeeded
    
    # ===== FINAL VERIFICATION =====
    - name: Get final namespace status
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: final_status
      when: namespace_creation is succeeded
    
    - name: Display final summary
      debug:
        msg: |
          ===== FINAL STATUS =====
          Namespace: {{ namespace_name }}
          Status: {{ final_status.json.status | default('UNKNOWN') }}
          Storage Policy: storageclass
          Creation Attempts: {{ namespace_creation.attempts | default(1) }}
          Permissions Set: {{ permission_setting is succeeded | default(false) | ternary('Yes', 'No') }}
          =========================