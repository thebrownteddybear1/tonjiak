---
- name: Create Supervisor Namespace 'vns' with VM Class and Editor Role
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
    namespace_role: "EDIT"
    vm_class_name: "best-effort-small"

  tasks:
    # ===== PHASE 1: AUTHENTICATION =====
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: true
        status_code: 201
      register: session_result

    # ===== PHASE 2: RESOURCE LOOKUP =====
    - name: Find cluster and storage policy IDs
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/{{ item }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      loop:
        - "cluster"
        - "storage/policies"
      register: resources

    - name: Set facts for IDs
      set_fact:
        # Note: These filters assume your cluster is named 'cluster' and policy named 'storageclass' 
        # as per your original logic.
        cluster_moid: "{{ (resources.results[0].json | selectattr('name', 'equalto', 'cluster') | list | first).cluster }}"
        storage_policy_id: "{{ (resources.results[1].json | selectattr('name', 'equalto', 'storageclass') | list | first).policy }}"

    # ===== PHASE 3: CLEANUP =====
    - name: Delete existing namespace if present
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: DELETE
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: [200, 204, 404]

    - name: Wait for deletion to complete
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 404
      register: del_status
      until: del_status.status == 404
      retries: 30
      delay: 5

    # ===== PHASE 4: CREATE & READY CHECK =====
    - name: Create Supervisor Namespace
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          cluster: "{{ cluster_moid }}"
          namespace: "{{ namespace_name }}"
          storage_specs:
            - policy: "{{ storage_policy_id }}"
              limit: -1
        status_code: [200, 201, 204]

    - name: Wait for Namespace to reach RUNNING state
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: ns_status
      until: "ns_status.json.config_status == 'RUNNING'"
      retries: 40
      delay: 5

    # ===== PHASE 5: ASSIGN VM CLASS =====
    - name: Assign VM Class '{{ vm_class_name }}' to Namespace
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/vm-classes/{{ vm_class_name }}"
        method: PUT
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: [200, 204]
      register: vm_class_assign
      until: vm_class_assign.status in [200, 204]
      retries: 10
      delay: 5

    # ===== PHASE 6: ACCESS CONTROL =====
    - name: Set Access permission
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/access"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          principal: "{{ vcenter_username }}"
          role: "{{ namespace_role }}"
          principal_type: "USER"
        status_code: [200, 201, 204]
      register: perm_set
      until: perm_set.status != 404
      retries: 20
      delay: 10
      ignore_errors: true

    - name: Verify Final Access
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/access"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: verify_access
      until: verify_access.status == 200
      retries: 10
      delay: 5

    - name: Final Confirmation
      debug:
        msg: |
          Namespace '{{ namespace_name }}' is fully provisioned.
          Status: {{ ns_status.json.config_status }}
          VM Class: {{ vm_class_name }} assigned successfully.
          Permissions: Verified for {{ vcenter_username }}