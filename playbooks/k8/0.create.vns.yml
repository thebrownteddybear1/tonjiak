---
- name: Create Supervisor Namespace 'vns' with Editor Role
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    vcenter_host: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    namespace_name: "vns"
    # standard role strings: OWNER, EDIT, VIEW
    namespace_role: "EDIT" 

  tasks:
    # ===== PHASE 1: AUTHENTICATION =====
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        validate_certs: false
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: true
        status_code: 201
      register: session_result

    # ===== PHASE 2: GET REQUIRED IDs =====
    - name: Find cluster 'cluster' MOID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/cluster"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: clusters

    - name: Set cluster MOID for 'cluster'
      set_fact:
        cluster_moid: "{{ item.cluster }}"
      loop: "{{ clusters.json }}"
      when: item.name == "cluster"

    - name: Fail if cluster 'cluster' not found
      fail:
        msg: "Cluster 'cluster' not found."
      when: cluster_moid is not defined

    - name: Find storage policy 'storageclass' ID
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/storage/policies"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: 200
      register: storage_policies

    - name: Set storage policy ID for 'storageclass'
      set_fact:
        storage_policy_id: "{{ item.policy }}"
      loop: "{{ storage_policies.json }}"
      when: item.name == "storageclass"

    # ===== PHASE 3: CLEANUP =====
    - name: Check if namespace exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: namespace_check
      ignore_errors: true

    - name: Delete namespace if it exists
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: DELETE
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
        status_code: [200, 204]
      when: namespace_check.status == 200

    - name: Sleep after deletion
      pause:
        seconds: 20
      when: namespace_check.status == 200

    # ===== PHASE 4: CREATE =====
    - name: Create Supervisor Namespace
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          cluster: "{{ cluster_moid }}"
          namespace: "{{ namespace_name }}"
          storage_specs:
            - policy: "{{ storage_policy_id }}"
              limit: -1
        status_code: [200, 201, 204]

    - name: Sleep for namespace initialization
      pause:
        seconds: 30

    # ===== PHASE 5: ACCESS CONTROL (The Fix) =====
    - name: Set Access permission (using /access endpoint)
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/access"
        method: POST
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
          Content-Type: "application/json"
        body_format: json
        body:
          principal: "{{ vcenter_username }}"
          role: "{{ namespace_role }}"
          principal_type: "USER"
        status_code: [200, 201, 204]
      register: permission_result

    # ===== PHASE 6: VERIFICATION =====
    - name: Check namespace final status
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: final_namespace

    - name: Get namespace access list
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/namespaces/instances/{{ namespace_name }}/access"
        method: GET
        validate_certs: false
        headers:
          vmware-api-session-id: "{{ session_result.json }}"
      register: final_access

    - name: Display Summary
      debug:
        msg: |
          ===== NAMESPACE SETUP COMPLETE =====
          Namespace: {{ namespace_name }}
          Status: {{ final_namespace.json.config_status }}
          
          Access Control List:
          {% for access in final_access.json %}
          - {{ access.principal }} (Role: {{ access.role }})
          {% endfor %}
          =====================================