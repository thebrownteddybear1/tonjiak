---
- name: Setup vSphere Datacenter and vLCM Cluster
  hosts: localhost
  gather_facts: false
  vars:
    vcenter_hostname: "192.168.50.52"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "VMware1!VMware1!"
    dc_name: "datacenter"
    cluster_name: "cluster"
    reference_host: "192.168.50.11"
    esxi_hosts:
      - "192.168.50.11"
      - "192.168.50.12"

  tasks:
    - name: 1. Create Datacenter
      community.vmware.vmware_datacenter:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter_name: "{{ dc_name }}"
        state: present
        validate_certs: false

    - name: 2. Add Hosts to Datacenter folder
      community.vmware.vmware_host:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter_name: "{{ dc_name }}"
        folder: "/{{ dc_name }}/host"
        esxi_hostname: "{{ item }}"
        esxi_username: "root"
        esxi_password: "VMware1!VMware1!"
        state: present
        validate_certs: false
      loop: "{{ esxi_hosts }}"

    - name: 3a. Get API Session Token
      uri:
        url: "https://{{ vcenter_hostname }}/api/session"
        method: POST
        user: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: yes
        status_code: 201
        validate_certs: false
      register: login

    - name: 3b. Create vLCM Cluster seeded from host .11
      uri:
        url: "https://{{ vcenter_hostname }}/api/vcenter/cluster"
        method: POST
        headers:
          vmware-api-session-id: "{{ login.json }}"
        body_format: json
        body:
          name: "{{ cluster_name }}"
          datacenter: "{{ dc_name }}"
          # This enables Lifecycle Manager and sets the reference host
          configuration:
            lifecycle_managed: true
          base_host: "{{ reference_host }}"
        status_code: [201, 409] # 409 if it already exists
        validate_certs: false

    - name: 4. Move Hosts into the Cluster
      community.vmware.vmware_host:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter_name: "{{ dc_name }}"
        cluster_name: "{{ cluster_name }}"
        esxi_hostname: "{{ item }}"
        state: present
        validate_certs: false
      loop: "{{ esxi_hosts }}"