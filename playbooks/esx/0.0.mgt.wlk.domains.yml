---
- name: Deploy VCF 9 Infrastructure - Full Stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    esxi_host: "192.168.50.108"
    esxi_user: "root"
    esxi_password: "VMware1!VMware1!"
    vm_folder: "/ha-datacenter/vm"
    
    # 28 vCPUs * 2100MHz * 0.12 = 7056 MHz
    workload_res_cpu: 7056

    # --- NFS STORAGE SERVER (FULLY RESERVED) ---
    # 16 vCPUs * 2100MHz = 33600 MHz
    # Pinned to Node 0, Threads 0-15
    nfs_server:
      - { name: "nfsserver", ram: 102400, res_mem: 102400, res_cpu: 33600, node: "0", aff: "0-15", vcpu: 16, latency: "high" }

    # --- MANAGEMENT CLUSTER ---
    # Mgmt nodes get priority affinity on Node 0 and Node 1
    esxi_mgmt:
      - { name: "esx11", ram: 256000, res_mem: 174080, res_cpu: 20000, node: "0", aff: "16-55", vcpu: 28, latency: "normal" }
      - { name: "esx12", ram: 256000, res_mem: 174080, res_cpu: 20000, node: "1", aff: "56-111", vcpu: 28, latency: "normal" }

    # --- WORKLOAD CLUSTER ---
    # Workload hosts distributed across sockets, avoiding NFS threads 0-15
    esxi_workload:
      - { name: "esx14", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "0", aff: "16-55", vcpu: 28, latency: "normal" }
      - { name: "esx15", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "1", aff: "56-111", vcpu: 28, latency: "normal" }
      - { name: "esx16", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "0", aff: "16-55", vcpu: 28, latency: "normal" }
      - { name: "esx17", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "1", aff: "56-111", vcpu: 28, latency: "normal" }
      - { name: "esx18", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "0", aff: "16-55", vcpu: 28, latency: "normal" }
      - { name: "esx19", ram: 102400, res_mem: 32768, res_cpu: "{{ workload_res_cpu }}", node: "1", aff: "56-111", vcpu: 28, latency: "normal" }

  tasks:
    - name: Apply Hardware, Reservations, and CPU Affinity
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_password }}"