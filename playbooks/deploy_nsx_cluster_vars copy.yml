cat > playbooks/deploy_nsx_complete.yml << 'EOF'
---
- hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # vCenter/ESXi Connection
    vcenter_host: "192.168.50.51"
    vcenter_user: "administrator@vsphere.local"
    vcenter_pass: "VMware1!"
    cluster: "cl1"
    
    # ESXi direct connection (fallback)
    esxi_host: "192.168.50.108"
    esxi_user: "root"
    esxi_pass: "VMware1!VMware1!VMware1!VMware1!"
    
    # OVA Configuration
    nsx_ova: "/root/tonjiak/nsx-unified-appliance-4.2.0.0.0.24105821.ova"
    vm_name: "nsx61.corp.internal"
    datastore: "sata4b"
    network: "VM Network"
    datacenter: "Datacenter"
    
    # Network Configuration
    mgmt_ip: "192.168.50.61"
    netmask: "255.255.255.0"
    gateway: "192.168.50.53"
    dns_server: "192.168.50.53"
    domain: "corp.internal"
    ntp_server: "192.168.50.53"
    
    # NSX Credentials
    nsx_username: "admin"
    nsx_password: "VMware1!VMware1!"
    
    # Deployment Settings
    deployment_size: "small"
    nsx_role: "NSX Manager"
    
    # Tool Paths
    ovftool_path: "/root/ovftool/ovftool"
    
    # Flags
    validate_certs: false
    use_vcenter: true  # Set to false to deploy directly to ESXi
    
  tasks:
    # ========== PREREQUISITE CHECKS ==========
    - name: Check if OVA file exists
      stat:
        path: "{{ nsx_ova }}"
      register: ova_check
      
    - name: Check if ovftool exists
      stat:
        path: "{{ ovftool_path }}"
      register: ovftool_check
      
    - name: Display prerequisite status
      debug:
        msg: |
          === Prerequisite Check ===
          OVA File ({{ nsx_ova }}): {{ '✓ EXISTS' if ova_check.stat.exists else '✗ MISSING' }}
          OVFTool ({{ ovftool_path }}): {{ '✓ EXISTS' if ovftool_check.stat.exists else '✗ MISSING' }}
          
    - name: Fail if prerequisites are missing
      fail:
        msg: "Missing prerequisites. Please check that OVA file and ovftool exist."
      when: not ova_check.stat.exists or not ovftool_check.stat.exists
      
    # ========== CONNECTIVITY TEST ==========
    - name: Test vCenter connectivity (if using vCenter)
      shell: |
        timeout 30 {{ ovftool_path }} \
          "vi://{{ vcenter_user }}:{{ vcenter_pass }}@{{ vcenter_host }}/" \
          2>&1 | grep -i "logged\|connected\|success" || true
      args:
        executable: /bin/bash
      register: vcenter_test
      ignore_errors: yes
      when: 
        - ova_check.stat.exists
        - ovftool_check.stat.exists
        - use_vcenter
      
    - name: Test ESXi connectivity (if not using vCenter)
      shell: |
        timeout 30 {{ ovftool_path }} \
          "vi://{{ esxi_user }}:{{ esxi_pass }}@{{ esxi_host }}/" \
          2>&1 | grep -i "logged\|connected\|success" || true
      args:
        executable: /bin/bash
      register: esxi_test
      ignore_errors: yes
      when: 
        - ova_check.stat.exists
        - ovftool_check.stat.exists
        - not use_vcenter
        
    - name: Display connectivity test results
      debug:
        msg: |
          === Connectivity Test Results ===
          vCenter test: {{ '✓ SUCCESS' if vcenter_test is succeeded and vcenter_test.stdout != '' else '✗ FAILED' if use_vcenter else 'SKIPPED' }}
          ESXi test: {{ '✓ SUCCESS' if esxi_test is succeeded and esxi_test.stdout != '' else '✗ FAILED' if not use_vcenter else 'SKIPPED' }}
          
    # ========== OVA DEPLOYMENT ==========
    - name: Deploy to vCenter
      shell: |
        set -x
        {{ ovftool_path }} \
          --acceptAllEulas \
          --noSSLVerify \
          --name="{{ vm_name }}" \
          --datastore="{{ datastore }}" \
          --network="{{ network }}" \
          --X:injectOvfEnv \
          --X:logFile=/tmp/ovftool-{{ vm_name }}-vcenter-$(date +%Y%m%d-%H%M%S).log \
          --X:logLevel=verbose \
          --prop:nsx_ip_0="{{ mgmt_ip }}" \
          --prop:nsx_netmask_0="{{ netmask }}" \
          --prop:nsx_gateway_0="{{ gateway }}" \
          --prop:nsx_dns1_0="{{ dns_server }}" \
          --prop:nsx_domain_0="{{ domain }}" \
          --prop:nsx_ntp_0="{{ ntp_server }}" \
          --prop:nsx_passwd_0="{{ nsx_password }}" \
          --prop:nsx_cli_passwd_0="{{ nsx_password }}" \
          --prop:nsx_hostname="{{ vm_name }}" \
          --prop:nsx_deployment_size="{{ deployment_size }}" \
          --prop:nsx_role="{{ nsx_role }}" \
          "{{ nsx_ova }}" \
          "vi://{{ vcenter_user }}:{{ vcenter_pass }}@{{ vcenter_host }}/{{ cluster }}"
      args:
        executable: /bin/bash
      register: vcenter_deploy
      when: 
        - ova_check.stat.exists
        - ovftool_check.stat.exists
        - use_vcenter
        - vcenter_test is succeeded
      ignore_errors: yes
      
    - name: Deploy directly to ESXi
      shell: |
        set -x
        {{ ovftool_path }} \
          --acceptAllEulas \
          --noSSLVerify \
          --name="{{ vm_name }}" \
          --datastore="{{ datastore }}" \
          --network="{{ network }}" \
          --X:injectOvfEnv \
          --X:logFile=/tmp/ovftool-{{ vm_name }}-esxi-$(date +%Y%m%d-%H%M%S).log \
          --X:logLevel=verbose \
          --prop:nsx_ip_0="{{ mgmt_ip }}" \
          --prop:nsx_netmask_0="{{ netmask }}" \
          --prop:nsx_gateway_0="{{ gateway }}" \
          --prop:nsx_dns1_0="{{ dns_server }}" \
          --prop:nsx_domain_0="{{ domain }}" \
          --prop:nsx_ntp_0="{{ ntp_server }}" \
          --prop:nsx_passwd_0="{{ nsx_password }}" \
          --prop:nsx_cli_passwd_0="{{ nsx_password }}" \
          --prop:nsx_hostname="{{ vm_name }}" \
          --prop:nsx_deployment_size="{{ deployment_size }}" \
          --prop:nsx_role="{{ nsx_role }}" \
          "{{ nsx_ova }}" \
          "vi://{{ esxi_user }}:{{ esxi_pass }}@{{ esxi_host }}/"
      args:
        executable: /bin/bash
      register: esxi_deploy
      when: 
        - ova_check.stat.exists
        - ovftool_check.stat.exists
        - (not use_vcenter or (use_vcenter and vcenter_deploy is failed))
      ignore_errors: yes
      
    # ========== DEPLOYMENT RESULTS ==========
    - name: Display deployment summary
      debug:
        msg: |
          === Deployment Summary ===
          Target: {{ 'vCenter' if use_vcenter else 'ESXi' }}
          VM Name: {{ vm_name }}
          Management IP: {{ mgmt_ip }}
          Status: {{ 
            '✓ SUCCESS (vCenter)' if vcenter_deploy is succeeded 
            else '✓ SUCCESS (ESXi)' if esxi_deploy is succeeded 
            else '✗ FAILED' 
          }}
          
    - name: Show deployment details (if successful)
      debug:
        msg: |
          === Deployment Details ===
          {{ vcenter_deploy.stdout if vcenter_deploy is succeeded else esxi_deploy.stdout if esxi_deploy is succeeded else 'No successful deployment' }}
      when: vcenter_deploy is succeeded or esxi_deploy is succeeded
      
    - name: Show error details (if failed)
      debug:
        msg: |
          === Error Details ===
          vCenter deployment error: {{ vcenter_deploy.stderr | default('N/A') }}
          ESXi deployment error: {{ esxi_deploy.stderr | default('N/A') }}
      when: vcenter_deploy is failed and esxi_deploy is failed
      
    # ========== POST-DEPLOYMENT VERIFICATION ==========
    - name: Wait for NSX Manager to become accessible
      wait_for:
        host: "{{ mgmt_ip }}"
        port: 443
        state: started
        delay: 30
        timeout: 600
      when: vcenter_deploy is succeeded or esxi_deploy is succeeded
      register: nsx_wait
      ignore_errors: yes
      
    - name: Test NSX Manager API connectivity
      uri:
        url: "https://{{ mgmt_ip }}/api/v1/node/services/http"
        method: GET
        user: "{{ nsx_username }}"
        password: "{{ nsx_password }}"
        validate_certs: "{{ validate_certs }}"
        force_basic_auth: yes
        status_code: 200
      register: nsx_api_test
      when: nsx_wait is succeeded
      ignore_errors: yes
      
    - name: Display final deployment status
      debug:
        msg: |
          === Final Deployment Status ===
          NSX Manager VM: {{ '✓ DEPLOYED' if vcenter_deploy is succeeded or esxi_deploy is succeeded else '✗ NOT DEPLOYED' }}
          Network reachable: {{ '✓ YES' if nsx_wait is succeeded else '✗ NO' }}
          API accessible: {{ '✓ YES' if nsx_api_test is succeeded else '✗ NO' }}
          
          Next steps:
          1. Access NSX Manager UI: https://{{ mgmt_ip }}
          2. Username: {{ nsx_username }}
          3. Password: {{ nsx_password }}
          4. Check /tmp/ovftool-*.log for detailed deployment logs
EOF