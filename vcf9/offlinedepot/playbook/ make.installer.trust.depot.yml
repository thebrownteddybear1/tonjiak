---
# PLAY 1: Generate Certificates Locally
- name: Generate Certificates Locally
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    fqdn: "depot.corp.internal"
  
  tasks:
    - name: Create the certificate generation script
      copy:
        dest: "{{ playbook_dir }}/tls.cert.key.sh"
        mode: '0755'
        content: |
          #!/bin/bash
          set -e
          FQDN="{{ fqdn }}"

          cat > server_openssl.cnf <<EOF
          [ req ]
          default_bits       = 2048
          distinguished_name = req_distinguished_name
          req_extensions     = req_ext
          prompt             = no

          [ req_distinguished_name ]
          C  = US
          ST = CA
          L  = Palo Alto
          O  = WilliamLam
          OU = R&D
          CN = ${FQDN}

          [ req_ext ]
          subjectAltName = @alt_names

          [ alt_names ]
          DNS.1 = ${FQDN}
          EOF

          openssl genrsa -out rootCA.key 4096
          openssl genrsa -out server.key 2048
          openssl req -new -key server.key -out server.csr -config server_openssl.cnf
          openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.pem -subj "/C=US/ST=CA/L=Palo Alto/O=WilliamLam/OU=R&D/CN=WilliamLam-RootCA"
          openssl x509 -req -in server.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out server.crt -days 825 -sha256 -extensions req_ext -extfile server_openssl.cnf
          cat server.crt rootCA.pem > depot-fullchain.pem

    - name: Run the generation script
      command: "./tls.cert.key.sh"
      args:
        chdir: "{{ playbook_dir }}"
      creates: "{{ playbook_dir }}/rootCA.pem"

# PLAY 2: Install and Trust Certs on VCF Appliance
- name: Install Certs on VCF Appliance
  hosts: vcf_appliance
  become: yes
  gather_facts: no
  vars:
    ansible_user: vcf
    ansible_ssh_pass: "VMware1!VMware1!"
    ansible_become_pass: "VMware1!VMware1!"
    # remote_cert_path: "/home/vcf/rootCA.pem"

  tasks:
    - name: SCP rootCA.pem to remote appliance
      copy:
        src: "{{ playbook_dir }}/rootCA.pem"
        dest: "/home/vcf/rootCA.pem"
        owner: vcf
        group: vcf
        mode: '0644'

    - name: Read the trusted certificates key password
      slurp:
        src: /etc/vmware/vcf/commonsvcs/trusted_certificates.key
      register: trusted_cert_key_encoded

    - name: Import certificate into SDDC Manager trust store
      shell: |
        keytool -importcert -alias depot -noprompt \
        -file /home/vcf/rootCA.pem \
        -keystore /etc/vmware/vcf/commonsvcs/trusted_certificates.store \
        -storepass {{ trusted_cert_key_encoded['content'] | b64decode | trim }}
      register: sddc_import
      failed_when: 
        - sddc_import.rc != 0
        - "'already exists' not in sddc_import.stdout"
        - "'already exists' not in sddc_import.stderr"
      changed_when: sddc_import.rc == 0

    - name: Import certificate into Java trust store
      shell: |
        keytool -importcert -alias depot -noprompt \
        -file /home/vcf/rootCA.pem \
        -keystore /etc/alternatives/jre/lib/security/cacerts \
        -storepass changeit
      register: java_import
      failed_when: 
        - java_import.rc != 0
        - "'already exists' not in java_import.stdout"
        - "'already exists' not in java_import.stderr"
      changed_when: java_import.rc == 0