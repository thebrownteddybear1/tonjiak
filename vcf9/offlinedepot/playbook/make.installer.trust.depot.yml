---
# PLAY 1: Generate SSL certificates for depot server locally
- name: Generate SSL certificates for depot
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    fqdn: "depot.corp.internal"

  tasks:
    - name: Create certs directory
      file:
        path: "{{ playbook_dir }}/certs"
        state: directory

    - name: Generate SSL certificates
      shell: |
        cd {{ playbook_dir }}/certs
        FQDN="{{ fqdn }}"
        
        cat > server_openssl.cnf <<EOF
        [ req ]
        default_bits       = 2048
        distinguished_name = req_distinguished_name
        req_extensions     = req_ext
        prompt             = no
        
        [ req_distinguished_name ]
        C  = US
        ST = CA
        L  = Palo Alto
        O  = WilliamLam
        OU = R&D
        CN = ${FQDN}
        
        [ req_ext ]
        subjectAltName = @alt_names
        
        [ alt_names ]
        DNS.1 = ${FQDN}
        EOF
        
        openssl genrsa -out rootCA.key 4096
        openssl genrsa -out server.key 2048
        openssl req -new -key server.key -out server.csr -config server_openssl.cnf
        openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.pem -subj "/C=US/ST=CA/L=Palo Alto/O=WilliamLam/OU=R&D/CN=WilliamLam-RootCA"
        openssl x509 -req -in server.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out server.crt -days 825 -sha256 -extensions req_ext -extfile server_openssl.cnf
        cat server.crt rootCA.pem > depot-fullchain.pem
      args:
        creates: "{{ playbook_dir }}/certs/rootCA.pem"

# PLAY 2: Copy rootCA.pem to VCF installer and follow KB procedure
- name: Configure VCF installer to trust depot (KB procedure)
  hosts: vcf_appliance
  gather_facts: no
  vars:
    ansible_user: vcf
    ansible_ssh_pass: "VMware1!VMware1!"
    ansible_become_pass: "VMware1!VMware1!"
    # Elevation settings
    ansible_become_method: su
    ansible_become_flags: '-'
    # Connection stability settings
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
    ansible_ssh_transfer_method: scp
    depot_ip: "192.168.50.53"

  tasks:
    - name: Copy rootCA.pem to VCF installer
      copy:
        src: "{{ playbook_dir }}/certs/rootCA.pem"
        dest: "/home/vcf/rootCA.pem"
        mode: '0644'

    - name: Get trusted certificates key
      become: yes
      shell: cat /etc/vmware/vcf/commonsvcs/trusted_certificates.key
      register: trust_key_result
      changed_when: false

    - name: Import to SDDC Manager trust store
      become: yes
      shell: |
        TRUST_PASS="{{ trust_key_result.stdout | trim }}"
        keytool -importcert -alias depot1 -noprompt \
          -file /home/vcf/rootCA.pem \
          -keystore /etc/vmware/vcf/commonsvcs/trusted_certificates.store \
          -storepass "$TRUST_PASS"
      register: sddc_import
      failed_when: 
        - sddc_import.rc != 0
        - "'already exists' not in sddc_import.stdout"
        - "'already exists' not in sddc_import.stderr"
      changed_when: sddc_import.rc == 0

    - name: Import to Java trust store
      become: yes
      shell: |
        keytool -importcert -alias depot1 -noprompt \
          -file /home/vcf/rootCA.pem \
          -keystore /etc/alternatives/jre/lib/security/cacerts \
          -storepass changeit
      register: java_import
      failed_when: 
        - java_import.rc != 0
        - "'already exists' not in java_import.stdout"
        - "'already exists' not in java_import.stderr"
      changed_when: java_import.rc == 0

    - name: Add depot.corp.internal to hosts file
      become: yes
      lineinfile:
        path: /etc/hosts
        line: "{{ depot_ip }} depot.corp.internal"
        state: present